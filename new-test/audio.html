<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionr Audio System</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #00e676;
            /* Modern bright green */
            --accent-dim: rgba(0, 230, 118, 0.1);
            --danger: #ff5252;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h2 {
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 10px;
            font-size: 1.8rem;
            color: var(--accent);
        }

        #connection-status {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 30px;
            font-weight: 500;
        }

        /* BUTTON STYLING */
        button {
            background-color: var(--accent);
            color: #000;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            margin-bottom: 40px;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 230, 118, 0.4);
            background-color: #00c853;
        }

        button:active {
            transform: translateY(0);
        }

        /* LAYOUT GRID */
        .dashboard-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 20px;
        }

        /* CARDS */
        .widget-box,
        .settings-box,
        .status-box {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: border 0.3s;
            border: 1px solid transparent;
        }

        .widget-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 20px;
            font-weight: 600;
            width: 100%;
            text-align: left;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        /* CANVAS CONTAINERS */
        .radar-view,
        .hud-view {
            position: relative;
            background: #181818;
            /* Slightly darker for contrast */
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .radar-view {
            border-radius: 150px 150px 0 0;
            border-bottom: none;
        }

        .hud-overlay {
            position: absolute;
            bottom: 15px;
            left: 15px;
            font-size: 12px;
            color: var(--accent);
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            border-radius: 4px;
            pointer-events: none;
        }

        .meta-text {
            margin-top: 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* SETTINGS & INPUTS */
        .bottom-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        @media (max-width: 768px) {
            .bottom-panel {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 15px;
            color: var(--text-main);
            width: 100%;
        }

        input[type=range] {
            width: 60%;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .status-box {
            align-items: flex-start;
            min-height: 200px;
        }

        #active-tags-list div {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            width: 100%;
            font-size: 0.9rem;
        }

        #active-tags-list div:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <h2>Visionr Dev Dashboard</h2>
    <div id="connection-status">Waiting for Signal...</div>
    <button onclick="initAudio()">Enable System</button>

    <div class="dashboard-wrapper">
        <div class="widget-box">
            <div class="widget-title">Top-Down Radar</div>
            <div class="radar-view">
                <canvas id="radarCanvas" width="300" height="150"></canvas>
            </div>
            <div class="meta-text">Scan Range: 3.0 Meters</div>
        </div>

        <div class="widget-box">
            <div class="widget-title">Visual HUD</div>
            <div class="hud-view">
                <canvas id="hudCanvas" width="400" height="300"></canvas>
                <div class="hud-overlay" id="hud-text">No Targets</div>
            </div>
            <div class="meta-text">FOV: 60°</div>
        </div>
    </div>

    <div class="bottom-panel">
        <div class="settings-box">
            <div class="widget-title">Audio Configuration</div>

            <label>
                <span>Motion Sensitivity</span>
                <input type="range" min="0.01" max="0.5" value="0.10" step="0.01" oninput="updateThreshold(this.value)">
            </label>
            <div
                style="font-size:0.8em; color:var(--text-muted); margin-top:-10px; margin-bottom:15px; text-align:right; width:100%">
                <span id="threshold-value">0.10</span>
            </div>

            <label>
                <span>Idle Interval (ms)</span>
                <input type="range" min="200" max="5000" value="1000" step="100"
                    oninput="updateBeepInterval(this.value)">
            </label>
            <div
                style="font-size:0.8em; color:var(--text-muted); margin-top:-10px; margin-bottom:15px; text-align:right; width:100%">
                <span id="interval-value">1000</span>
            </div>

            <label>
                <span>Beep Duration (ms)</span>
                <input type="range" min="50" max="500" value="100" step="10" oninput="updateBeepDuration(this.value)">
            </label>
            <div
                style="font-size:0.8em; color:var(--text-muted); margin-top:-10px; margin-bottom:0px; text-align:right; width:100%">
                <span id="duration-value">100</span>
            </div>
        </div>

        <div class="status-box">
            <div class="widget-title">Active Targets</div>
            <div id="active-tags-list" style="width: 100%;">
                <div style="color: var(--text-muted); font-style: italic;">Awaiting Data...</div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBALS ---
        let ctx;
        let isAudioInit = false;
        let MOTION_THRESHOLD = 0.10;
        let IDLE_BEEP_INTERVAL = 1000;
        let BEEP_DURATION = 100;
        const activeSounds = {};

        const TAG_NAMES = {
            0: "Exit", 1: "Enter", 2: "Map",
            3: "Room 1", 4: "Room 2", 5: "Room 3",
            "default": "Unknown"
        };

        // Frequencies mapped to tags
        const TAG_FREQUENCIES = {
            0: 261.63, 1: 293.66, 2: 329.63,
            3: 349.23, 4: 392.00, 5: 440.00,
            "default": 100.00
        };

        // --- CANVAS SETUP ---
        const radarCanvas = document.getElementById('radarCanvas');
        const radarCtx = radarCanvas.getContext('2d');
        const hudCanvas = document.getElementById('hudCanvas');
        const hudCtx = hudCanvas.getContext('2d');
        const hudText = document.getElementById('hud-text');

        // --- WEBSOCKET ---
        const socket = new WebSocket('ws://localhost:8765');
        const statusDiv = document.getElementById('connection-status');
        const listDiv = document.getElementById('active-tags-list');

        function updateThreshold(val) { MOTION_THRESHOLD = parseFloat(val); document.getElementById('threshold-value').innerText = val; }
        function updateBeepInterval(val) { IDLE_BEEP_INTERVAL = parseInt(val); document.getElementById('interval-value').innerText = val; }
        function updateBeepDuration(val) { BEEP_DURATION = parseInt(val); document.getElementById('duration-value').innerText = val; }

        socket.addEventListener('open', () => {
            statusDiv.innerText = "● System Online";
            statusDiv.style.color = "#00e676";
            drawRadarGrid();
            drawHUDGrid();
        });

        socket.addEventListener('message', (event) => {
            if (!isAudioInit) return;

            const visibleTags = JSON.parse(event.data);
            const visibleIds = new Set();
            let html = "";

            // 1. Clear Canvases
            drawRadarGrid();
            drawHUDGrid();

            visibleTags.forEach(tag => {
                visibleIds.add(tag.id);

                // Data mapping
                const rawX = tag.pose[0];
                const rawY = tag.pose[1];
                const rawZ = tag.pose[2];

                // 2. Draw Visuals
                drawRadarDot(rawX, rawZ, TAG_NAMES[tag.id], tag.id);
                drawHUDTarget(rawX, rawY, rawZ, TAG_NAMES[tag.id], tag.id);

                // 3. Audio Update
                const audioX = rawX * 5;
                const audioY = -rawY * 5;
                const audioZ = Math.abs(rawZ);

                if (!activeSounds[tag.id]) {
                    createSound(tag.id, audioX, audioY, audioZ);
                }
                updateSoundPosition(tag.id, audioX, audioY, audioZ);

                // 4. Update List HTML
                const sound = activeSounds[tag.id];
                const isActive = sound && sound.isMoving;
                const statusColor = isActive ? "#00e676" : "#e0e0e0";
                const icon = isActive ? "▶" : "•";

                html += `<div style="display:flex; justify-content:space-between; color:${statusColor}">
                            <span>${icon} <strong>${TAG_NAMES[tag.id] || "Unknown"}</strong> <small>(ID:${tag.id})</small></span>
                            <span>${rawZ.toFixed(2)}m</span>
                         </div>`;
            });

            listDiv.innerHTML = html || `<div style="color: var(--text-muted); font-style: italic;">No targets detected</div>`;
            hudText.innerText = visibleTags.length > 0 ? `${visibleTags.length} Targets Active` : "No Targets";

            // Cleanup
            for (const id in activeSounds) {
                if (!visibleIds.has(parseInt(id))) removeSound(id);
            }
        });

        socket.addEventListener('close', () => {
            statusDiv.innerText = "● Connection Lost";
            statusDiv.style.color = "#ff5252";
        });

        // --- DRAWING: RADAR ---
        function drawRadarGrid() {
            const w = radarCanvas.width;
            const h = radarCanvas.height;
            const cx = w / 2;
            const cy = h;

            radarCtx.clearRect(0, 0, w, h);
            radarCtx.lineWidth = 1;
            radarCtx.strokeStyle = '#333'; // Subtle grid color

            // Arcs
            radarCtx.beginPath(); radarCtx.arc(cx, cy, 40, Math.PI, 0); radarCtx.stroke();
            radarCtx.beginPath(); radarCtx.arc(cx, cy, 80, Math.PI, 0); radarCtx.stroke();
            radarCtx.beginPath(); radarCtx.arc(cx, cy, 120, Math.PI, 0); radarCtx.stroke();

            // Diagonals
            radarCtx.beginPath();
            radarCtx.moveTo(cx, cy); radarCtx.lineTo(cx - 120, cy - 120);
            radarCtx.moveTo(cx, cy); radarCtx.lineTo(cx + 120, cy - 120);
            radarCtx.moveTo(cx, cy); radarCtx.lineTo(cx, cy - 140);
            radarCtx.stroke();

            // Self (White Dot)
            radarCtx.fillStyle = '#fff';
            radarCtx.beginPath();
            radarCtx.arc(cx, cy - 5, 3, 0, Math.PI * 2);
            radarCtx.fill();
        }

        function drawRadarDot(x, z, name, id) {
            const w = radarCanvas.width;
            const cx = w / 2;
            const cy = radarCanvas.height;
            const scale = 75;

            const plotX = cx + (x * scale);
            const plotY = cy - (z * scale);

            // Dot
            radarCtx.fillStyle = '#00e676';
            radarCtx.beginPath();
            radarCtx.arc(plotX, plotY, 4, 0, Math.PI * 2);
            radarCtx.fill();

            // Label
            radarCtx.fillStyle = '#e0e0e0';
            radarCtx.font = '10px Segoe UI';
            radarCtx.fillText(name || id, plotX + 6, plotY + 3);
        }

        // --- DRAWING: HUD ---
        function drawHUDGrid() {
            const w = hudCanvas.width;
            const h = hudCanvas.height;
            const cx = w / 2;
            const cy = h / 2;

            hudCtx.clearRect(0, 0, w, h);
            hudCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)'; // Very subtle
            hudCtx.lineWidth = 1;

            // Crosshair
            hudCtx.strokeStyle = 'rgba(0, 230, 118, 0.5)';
            hudCtx.beginPath();
            hudCtx.moveTo(cx - 10, cy); hudCtx.lineTo(cx + 10, cy);
            hudCtx.moveTo(cx, cy - 10); hudCtx.lineTo(cx, cy + 10);
            hudCtx.stroke();
        }

        function drawHUDTarget(x, y, z, name, id) {
            const w = hudCanvas.width;
            const h = hudCanvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const scale = 200;

            const screenX = cx + (x * scale);
            const screenY = cy + (y * scale);

            let size = 40 / z;
            if (size > 80) size = 80;
            if (size < 10) size = 10;

            hudCtx.strokeStyle = '#00e676';
            hudCtx.lineWidth = 2;

            // Draw Corners (Minimal bracket style)
            const gap = size / 2;

            hudCtx.beginPath();
            // Top Left
            hudCtx.moveTo(screenX - size, screenY - size + gap);
            hudCtx.lineTo(screenX - size, screenY - size);
            hudCtx.lineTo(screenX - size + gap, screenY - size);
            // Bottom Right
            hudCtx.moveTo(screenX + size, screenY + size - gap);
            hudCtx.lineTo(screenX + size, screenY + size);
            hudCtx.lineTo(screenX + size - gap, screenY + size);
            hudCtx.stroke();

            // Label
            hudCtx.fillStyle = '#fff';
            hudCtx.font = 'bold 11px Segoe UI';
            hudCtx.fillText(name || id, screenX + size + 5, screenY - 5);
            hudCtx.fillStyle = '#a0a0a0';
            hudCtx.font = '10px Segoe UI';
            hudCtx.fillText(`${z.toFixed(2)}m`, screenX + size + 5, screenY + 8);
        }

        // --- AUDIO ENGINE ---
        async function initAudio() {
            if (ctx) return;
            ctx = new (window.AudioContext || window.webkitAudioContext)();
            isAudioInit = true;
            console.log("Audio Engine Initialized");

            const btn = document.querySelector('button');
            btn.innerText = "System Active";
            btn.style.backgroundColor = "#333";
            btn.style.color = "#00e676";
            btn.disabled = true;

            drawRadarGrid();
            drawHUDGrid();
            requestAnimationFrame(audioLoop);
        }

        function createSound(id, x, y, z) {
            const freq = TAG_FREQUENCIES[id] || TAG_FREQUENCIES["default"];
            const osc = ctx.createOscillator();
            osc.type = "sine"; // Softer sound than sawtooth
            osc.frequency.value = freq;
            const gain = ctx.createGain();
            gain.gain.value = 0;
            const panner = new PannerNode(ctx, {
                panningModel: "HRTF", distanceModel: "exponential",
                positionX: x, positionY: y, positionZ: z,
                refDistance: 1, maxDistance: 100, rolloffFactor: 1.5,
            });
            osc.connect(gain).connect(panner).connect(ctx.destination);
            osc.start();
            activeSounds[id] = { osc, panner, gain, lastX: x, lastY: y, lastZ: z, lastMoveTime: Date.now(), lastBeepTime: 0, isMoving: false, isBeeping: false };
        }

        function updateSoundPosition(id, x, y, z) {
            const sound = activeSounds[id];
            if (!sound) return;
            const dist = Math.sqrt(Math.pow(x - sound.lastX, 2) + Math.pow(y - sound.lastY, 2) + Math.pow(z - sound.lastZ, 2));
            sound.isMoving = dist > MOTION_THRESHOLD;
            sound.lastX = x; sound.lastY = y; sound.lastZ = z;
            sound.panner.positionX.setTargetAtTime(x, ctx.currentTime, 0.05);
            sound.panner.positionY.setTargetAtTime(y, ctx.currentTime, 0.05);
            sound.panner.positionZ.setTargetAtTime(z, ctx.currentTime, 0.05);
        }

        function audioLoop() {
            const now = Date.now();
            for (const id in activeSounds) {
                const sound = activeSounds[id];
                if (sound.isMoving) {
                    sound.gain.gain.setTargetAtTime(0.1, ctx.currentTime, 0.02);
                } else {
                    if (!sound.isBeeping) sound.gain.gain.setTargetAtTime(0, ctx.currentTime, 0.02);
                    if (now - sound.lastBeepTime > IDLE_BEEP_INTERVAL) triggerBeep(sound, now);
                }
            }
            requestAnimationFrame(audioLoop);
        }

        function triggerBeep(sound, now) {
            sound.isBeeping = true;
            sound.lastBeepTime = now;
            sound.gain.gain.cancelScheduledValues(ctx.currentTime);
            sound.gain.gain.setValueAtTime(sound.gain.gain.value, ctx.currentTime);
            sound.gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.01);
            sound.gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + BEEP_DURATION / 1000);
            sound.gain.gain.linearRampToValueAtTime(0, ctx.currentTime + (BEEP_DURATION + 10) / 1000);
            setTimeout(() => { sound.isBeeping = false; }, BEEP_DURATION + 20);
        }

        function removeSound(id) {
            const sound = activeSounds[id];
            if (!sound) return;
            sound.gain.gain.setTargetAtTime(0, ctx.currentTime, 0.02);
            setTimeout(() => {
                sound.osc.stop(); sound.osc.disconnect();
                sound.panner.disconnect(); sound.gain.disconnect();
            }, 50);
            delete activeSounds[id];
        }
    </script>
</body>

</html>