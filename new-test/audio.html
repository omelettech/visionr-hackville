<!doctype html>
<html>

<head>
    <title>AprilTag 3D Audio</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #222;
            color: #fff;
            text-align: center;
        }

        .data-display {
            margin-top: 20px;
            font-size: 1.2em;
            font-family: monospace;
            color: #0f0;
        }

        .status {
            margin-bottom: 20px;
            color: #888;
        }

        button {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            background: #0f0;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <h2>AprilTag 3D Audio Positioner</h2>

    <div class="status" id="connection-status">Connecting to WebSocket...</div>

    <button onclick="initAudio()">Enable Audio (Click Me First)</button>

    <div class="data-display">
        <div>Tracking Tag ID: <span id="tag-id">None</span></div>
        <div>X: <span id="val-x">0</span></div>
        <div>Y: <span id="val-y">0</span></div>
        <div>Z: <span id="val-z">0</span></div>
    </div>

    <script>
        let ctx, panner, oscillator;
        // Default position
        let currentPos = { x: 0, y: 0, z: 1 };

        // Connect to the Python Server
        const socket = new WebSocket('ws://localhost:8765');
        const statusDiv = document.getElementById('connection-status');

        // --- WEBSOCKET LOGIC ---

        socket.addEventListener('open', () => {
            statusDiv.innerText = "Connected to Python Server";
            statusDiv.style.color = "#0f0";
        });

        socket.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);

            // If we detect at least one tag
            if (data.length > 0) {
                const tag = data[0]; // Track the first tag found

                // AprilTag Coordinates:
                // X = Left/Right (Meters)
                // Y = Up/Down (Meters) (Note: In Computer Vision, Y is often Down. In Web Audio, Y is Up)
                // Z = Depth (Meters)

                // We map them to the Panner
                // We flip Y so that lifting the tag up sounds "up"
                const x = tag.pose[0] * 5; // Multiplied by 5 to exaggerate the effect
                const y = -tag.pose[1] * 5;
                const z = Math.abs(tag.pose[2]);

                // Update UI
                document.getElementById('tag-id').innerText = tag.id;
                document.getElementById('val-x').innerText = x.toFixed(2);
                document.getElementById('val-y').innerText = y.toFixed(2);
                document.getElementById('val-z').innerText = z.toFixed(2);

                // Update Audio Engine
                updateAudioPosition(x, y, z);
            }
        });

        socket.addEventListener('close', () => {
            statusDiv.innerText = "Disconnected from Server";
            statusDiv.style.color = "#f00";
        });

        // --- AUDIO LOGIC ---

        async function initAudio() {
            if (ctx) return; // Prevent multiple clicks

            ctx = new (window.AudioContext || window.webkitAudioContext)();

            // 1. Create Oscillator (The buzzing sound)
            oscillator = ctx.createOscillator();
            oscillator.type = "sawtooth";
            oscillator.frequency.setValueAtTime(440, ctx.currentTime);

            // 2. Create Panner (The 3D effect)
            panner = new PannerNode(ctx, {
                panningModel: "HRTF",      // Head-Related Transfer Function (High Quality)
                distanceModel: "inverse", // Volume drops faster as you move away
                positionX: 0,
                positionY: 0,
                positionZ: 1,
                refDistance: 1,            // Distance where volume is 100%
                maxDistance: 100,
                rolloffFactor: 1,
            });

            // 3. Connect: Osc -> Panner -> Speakers
            oscillator.connect(panner).connect(ctx.destination);
            oscillator.start();

            console.log("Audio Engine Started");
        }

        function updateAudioPosition(x, y, z) {
            if (!panner || !ctx) return;

            // Smoothly transition to new coordinates to prevent clicking/popping
            // We use setTargetAtTime for a smooth slide
            const timeConstant = 0.1;

            panner.positionX.setTargetAtTime(x, ctx.currentTime, timeConstant);
            panner.positionY.setTargetAtTime(y, ctx.currentTime, timeConstant);
            panner.positionZ.setTargetAtTime(z, ctx.currentTime, timeConstant);
        }
    </script>
</body>

</html>