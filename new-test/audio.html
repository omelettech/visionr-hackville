<!doctype html>
<html>

<head>
    <title>AprilTag Polyphonic 3D Audio</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #222;
            color: #fff;
            text-align: center;
        }

        .status {
            margin-bottom: 20px;
            color: #888;
        }

        button {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            background: #0f0;
            border: none;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        #active-tags-list {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tag-card {
            border: 1px solid #444;
            background: #333;
            padding: 10px;
            border-radius: 8px;
            width: 120px;
        }
    </style>
</head>

<body>
    <h2>Polyphonic 3D Audio Positioner</h2>

    <div class="status" id="connection-status">Connecting to WebSocket...</div>

    <button onclick="initAudio()">Enable Audio (Click Me First)</button>

    <h3>Active Tags</h3>
    <div id="active-tags-list">Waiting for tags...</div>

    <script>
        let ctx;
        let isAudioInit = false;

        // Store active audio nodes here: 
        // { tagId: { osc, panner, gain, lastSeenTime } }
        const activeSounds = {};

        // Map Tag IDs to Frequencies (Notes)
        const TAG_FREQUENCIES = {
            0: 261.63, // C4
            1: 293.66, // D4
            2: 329.63, // E4
            3: 349.23, // F4
            4: 392.00, // G4
            5: 440.00, // A4
            "default": 100.00
        };

        const socket = new WebSocket('ws://localhost:8765');
        const statusDiv = document.getElementById('connection-status');
        const listDiv = document.getElementById('active-tags-list');

        // --- WEBSOCKET LOGIC ---

        socket.addEventListener('open', () => {
            statusDiv.innerText = "Connected to Python Server";
            statusDiv.style.color = "#0f0";
        });

        socket.addEventListener('message', (event) => {
            if (!isAudioInit) return; // Don't process until user clicks button

            const visibleTags = JSON.parse(event.data);
            const visibleIds = new Set();
            let html = "";

            // 1. Process Visible Tags (Create or Update)
            visibleTags.forEach(tag => {
                visibleIds.add(tag.id);

                // Coordinates
                const x = tag.pose[0] * 5;
                const y = -tag.pose[1] * 5;
                const z = Math.abs(tag.pose[2]);

                // Update UI HTML
                html += `
                    <div class="tag-card">
                        <div style="font-size:1.5em; color:#0f0">${tag.id}</div>
                        <div style="font-size:0.8em">X: ${x.toFixed(1)}</div>
                        <div style="font-size:0.8em">Side: ${x < 0 ? 'Left' : 'Right'}</div>
                    </div>
                `;

                // Update Audio
                if (!activeSounds[tag.id]) {
                    // New tag found! Create a sound.
                    createSound(tag.id);
                }

                // Update position for this specific tag
                updateSoundPosition(tag.id, x, y, z);
            });

            listDiv.innerHTML = html || "No tags visible";

            // 2. Cleanup Missing Tags (Garbage Collection)
            // If a tag was active but is not in the current visible list, remove it.
            for (const id in activeSounds) {
                // Note: keys in objects are strings, need to convert to int for comparison
                if (!visibleIds.has(parseInt(id))) {
                    removeSound(id);
                }
            }
        });

        socket.addEventListener('close', () => {
            statusDiv.innerText = "Disconnected";
            statusDiv.style.color = "#f00";
        });

        // --- AUDIO ENGINE ---

        async function initAudio() {
            if (ctx) return;
            ctx = new (window.AudioContext || window.webkitAudioContext)();
            isAudioInit = true;
            console.log("Audio Engine Started");
        }

        function createSound(id) {
            const freq = TAG_FREQUENCIES[id] || TAG_FREQUENCIES["default"];

            // 1. Oscillator (Source)
            const osc = ctx.createOscillator();
            osc.type = "sawtooth";
            osc.frequency.value = freq;

            // 2. Gain Node (Volume control for fading in/out)
            const gain = ctx.createGain();
            gain.gain.value = 0; // Start silent, fade in

            // 3. Panner Node (3D Position)
            const panner = new PannerNode(ctx, {
                panningModel: "HRTF",
                distanceModel: "exponential",
                positionX: 0,
                positionY: 0,
                positionZ: 1,
                refDistance: 1,
                maxDistance: 100,
                rolloffFactor: 1.5,
            });

            // Connect: Osc -> Gain -> Panner -> Speakers
            osc.connect(gain).connect(panner).connect(ctx.destination);
            osc.start();

            // Fade in volume over 0.1s to avoid clicking
            gain.gain.setTargetAtTime(0.1, ctx.currentTime, 0.1);

            // Save to our active map
            activeSounds[id] = { osc, panner, gain };
        }

        function updateSoundPosition(id, x, y, z) {
            const sound = activeSounds[id];
            if (!sound) return;

            const timeConstant = 0.1;
            sound.panner.positionX.setTargetAtTime(x, ctx.currentTime, timeConstant);
            sound.panner.positionY.setTargetAtTime(y, ctx.currentTime, timeConstant);
            sound.panner.positionZ.setTargetAtTime(z, ctx.currentTime, timeConstant);
        }

        function removeSound(id) {
            const sound = activeSounds[id];
            if (!sound) return;

            // 1. Fade out volume to 0 over 0.2s
            sound.gain.gain.setTargetAtTime(0, ctx.currentTime, 0.2);

            // 2. Stop and disconnect after fade is done
            setTimeout(() => {
                sound.osc.stop();
                sound.osc.disconnect();
                sound.panner.disconnect();
                sound.gain.disconnect();
            }, 250);

            // 3. Remove from map immediately so we don't try to update it
            delete activeSounds[id];
        }
    </script>
</body>

</html>