<!doctype html>
<html>

<head>
    <title>AprilTag Tactical Display</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            padding: 20px;
            background: #111;
            color: #0f0;
            text-align: center;
            margin: 0;
        }

        h2 {
            margin-top: 0;
            text-shadow: 0 0 10px #0f0;
        }

        button {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            background: #0f0;
            color: #000;
            border: none;
            border-radius: 2px;
            margin-bottom: 20px;
            font-weight: bold;
            font-family: inherit;
        }

        button:hover {
            background: #fff;
        }

        /* MAIN LAYOUT */
        .dashboard-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
        }

        /* WIDGET CONTAINERS */
        .widget-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .widget-title {
            background: #002200;
            color: #0f0;
            padding: 5px 15px;
            border: 1px solid #0f0;
            border-bottom: none;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* 1. RADAR STYLING */
        .radar-view {
            background: #000;
            border: 2px solid #0f0;
            border-radius: 150px 150px 0 0;
            width: 300px;
            height: 150px;
            box-shadow: 0 -5px 20px rgba(0, 255, 0, 0.2);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            overflow: hidden;
        }

        /* 2. HUD STYLING */
        .hud-view {
            background: #000;
            border: 2px solid #0f0;
            border-radius: 10px;
            width: 400px;
            height: 300px;
            /* Taller to distinguish from radar */
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            position: relative;
            cursor: crosshair;
        }

        .hud-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 12px;
            pointer-events: none;
            color: #0f0;
        }

        /* SETTINGS & LISTS */
        .bottom-panel {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .settings-box,
        .status-box {
            background: #001100;
            border: 1px solid #0f0;
            padding: 15px;
            text-align: left;
            min-width: 250px;
        }
    </style>
</head>

<body>
    <h2>TACTICAL AUDIO SYSTEM</h2>
    <div id="connection-status" style="color: #666; margin-bottom: 10px;">STANDBY...</div>
    <button onclick="initAudio()">INITIALIZE SYSTEMS</button>

    <div class="dashboard-wrapper">

        <div class="widget-box">
            <div class="widget-title">RADAR (TOP-DOWN)</div>
            <div class="radar-view">
                <canvas id="radarCanvas" width="300" height="150"></canvas>
            </div>
            <div style="font-size: 0.8em; color: #0f0; margin-top: 5px;">RANGE: 3 METERS</div>
        </div>

        <div class="widget-box">
            <div class="widget-title">HUD (VISUAL)</div>
            <div class="hud-view">
                <canvas id="hudCanvas" width="400" height="300"></canvas>
                <div class="hud-overlay" id="hud-text">NO TARGETS</div>
            </div>
            <div style="font-size: 0.8em; color: #0f0; margin-top: 5px;">FOV: 60 DEGREES</div>
        </div>

    </div>

    <div class="bottom-panel">
        <div class="settings-box">
            <h3 style="margin: 0 0 10px 0; border-bottom: 1px solid #0f0;">AUDIO PARAMS</h3>
            <label style="display: block; margin-bottom: 5px;">
                Motion Thresh: <span id="threshold-value">0.02</span>
                <input type="range" min="0.01" max="0.5" value="0.02" step="0.01" oninput="updateThreshold(this.value)"
                    style="width: 100%;">
            </label>
            <label style="display: block; margin-bottom: 5px;">
                Idle Beep: <span id="interval-value">3000</span>ms
                <input type="range" min="200" max="5000" value="3000" step="100"
                    oninput="updateBeepInterval(this.value)" style="width: 100%;">
            </label>
            <label style="display: block; margin-bottom: 15px;">
                Beep Duration: <span id="duration-value">100</span>ms
                <input type="range" min="50" max="500" value="100" step="10" oninput="updateBeepDuration(this.value)"
                    style="width: 100%;">
            </label>
        </div>

        <div class="status-box" id="active-tags-list">
            <h3 style="margin: 0 0 10px 0; border-bottom: 1px solid #0f0;">TARGET LIST</h3>
            <div>Awaiting Data...</div>
        </div>
    </div>

    <script src="spatialAudio.js"></script>
    <script>
        // --- GLOBALS ---
        const audioManager = new SpatialAudioManager({
            motionThreshold: 0.02,
            idleBeepInterval: 3000,
            baseVolume: 3.0
        });

        // --- CANVAS SETUP ---
        const radarCanvas = document.getElementById('radarCanvas');
        const radarCtx = radarCanvas.getContext('2d');
        const hudCanvas = document.getElementById('hudCanvas');
        const hudCtx = hudCanvas.getContext('2d');
        const hudText = document.getElementById('hud-text');

        // --- AUDIO SETTINGS ---
        function updateThreshold(val) {
            audioManager.updateThreshold(val);
            document.getElementById('threshold-value').innerText = val;
        }
        function updateBeepInterval(val) {
            audioManager.updateBeepInterval(val);
            document.getElementById('interval-value').innerText = val;
        }
        function updateBeepDuration(val) {
            audioManager.updateBeepDuration(val);
            document.getElementById('duration-value').innerText = val;
        }

        // --- WEBSOCKET ---
        const socket = new WebSocket('ws://localhost:8765');
        const statusDiv = document.getElementById('connection-status');
        const listDiv = document.getElementById('active-tags-list');

        socket.addEventListener('open', () => {
            statusDiv.innerText = "LINK ESTABLISHED";
            statusDiv.style.color = "#0f0";
            drawRadarGrid();
            drawHUDGrid();
        });

        socket.addEventListener('message', (event) => {
            if (!audioManager.isAudioInit) return;

            const visibleTags = JSON.parse(event.data);
            const visibleIds = new Set();
            let html = "";

            drawRadarGrid();
            drawHUDGrid();

            visibleTags.forEach(tag => {
                visibleIds.add(tag.id);

                const rawX = tag.pose[0];
                const rawY = tag.pose[1];
                const rawZ = tag.pose[2];

                drawRadarDot(rawX, rawZ, tag.id);
                drawHUDTarget(rawX, rawY, rawZ, tag.id);

                const audioX = rawX * 5;
                const audioY = rawY * 10;
                const audioZ = Math.abs(rawZ);

                if (!audioManager.activeSounds[tag.id]) {
                    audioManager.createSound(tag.id, audioX, audioY, audioZ);
                }
                audioManager.updateSoundPosition(tag.id, audioX, audioY, audioZ);

                const sound = audioManager.activeSounds[tag.id];
                const status = (sound && sound.isMoving) ? "MOVING" : "STATIC";
                html += `<div style="margin-bottom:5px; color:${sound.isMoving ? '#0f0' : '#666'}">
                            [ID:${tag.id}] Z:${rawZ.toFixed(2)}m - ${status}
                         </div>`;
            });

            listDiv.innerHTML = html || "No Targets Detected";
            hudText.innerText = `TARGETS: ${visibleTags.length}`;

            for (const id in audioManager.activeSounds) {
                if (!visibleIds.has(parseInt(id))) audioManager.removeSound(id);
            }
        });

        socket.addEventListener('close', () => {
            statusDiv.innerText = "CONNECTION LOST";
            statusDiv.style.color = "#f00";
        });

        // --- RENDERING ---
        function drawRadarGrid() {
            const w = radarCanvas.width, h = radarCanvas.height;
            const cx = w / 2, cy = h;
            radarCtx.clearRect(0, 0, w, h);
            radarCtx.lineWidth = 1; radarCtx.strokeStyle = '#004400';
            for (let r = 40; r <= 120; r += 40) { radarCtx.beginPath(); radarCtx.arc(cx, cy, r, Math.PI, 0); radarCtx.stroke(); }
            radarCtx.beginPath(); radarCtx.moveTo(cx, cy); radarCtx.lineTo(cx - 120, cy - 120); radarCtx.moveTo(cx, cy); radarCtx.lineTo(cx + 120, cy - 120); radarCtx.moveTo(cx, cy); radarCtx.lineTo(cx, cy - 140); radarCtx.stroke();
            radarCtx.strokeStyle = '#0f0'; radarCtx.beginPath(); radarCtx.moveTo(cx - 10, cy - 5); radarCtx.lineTo(cx + 10, cy - 5); radarCtx.moveTo(cx, cy - 15); radarCtx.lineTo(cx, cy + 5); radarCtx.stroke();
        }

        function drawRadarDot(x, z, id) {
            const w = radarCanvas.width, cx = w / 2, cy = radarCanvas.height, scale = 75;
            const plotX = cx + (x * scale), plotY = cy - (z * scale);
            radarCtx.fillStyle = '#f00'; radarCtx.beginPath(); radarCtx.arc(plotX, plotY, 5, 0, Math.PI * 2); radarCtx.fill();
            radarCtx.fillStyle = '#fff'; radarCtx.font = '10px Courier New'; radarCtx.fillText(id, plotX + 6, plotY - 6);
        }

        function drawHUDGrid() {
            const w = hudCanvas.width, h = hudCanvas.height, cx = w / 2, cy = h / 2;
            hudCtx.clearRect(0, 0, w, h);
            hudCtx.strokeStyle = '#003300'; hudCtx.lineWidth = 1;
            hudCtx.strokeStyle = '#0f0'; hudCtx.beginPath(); hudCtx.moveTo(cx - 20, cy); hudCtx.lineTo(cx + 20, cy); hudCtx.moveTo(cx, cy - 20); hudCtx.lineTo(cx, cy + 20); hudCtx.stroke();
            hudCtx.beginPath(); hudCtx.arc(cx, cy, 10, 0, Math.PI * 2); hudCtx.stroke();
        }

        function drawHUDTarget(x, y, z, id) {
            const w = hudCanvas.width, h = hudCanvas.height, cx = w / 2, cy = h / 2, scale = 200;
            const screenX = cx + (x * scale), screenY = cy + (y * scale);
            let size = 40 / z; size = Math.min(100, Math.max(10, size));
            hudCtx.strokeStyle = '#f00'; hudCtx.lineWidth = 2;
            hudCtx.beginPath();
            hudCtx.moveTo(screenX - size, screenY - size + size / 2); hudCtx.lineTo(screenX - size, screenY - size); hudCtx.lineTo(screenX - size + size / 2, screenY - size);
            hudCtx.moveTo(screenX + size, screenY + size - size / 2); hudCtx.lineTo(screenX + size, screenY + size); hudCtx.lineTo(screenX + size - size / 2, screenY + size);
            hudCtx.stroke();
            hudCtx.fillStyle = '#0f0'; hudCtx.font = '12px Courier New';
            hudCtx.fillText(`ID:${id}`, screenX + size + 5, screenY - 5); hudCtx.fillText(`D:${z.toFixed(2)}`, screenX + size + 5, screenY + 10);
        }

        async function initAudio() {
            if (audioManager.isAudioInit) return;
            await audioManager.init();
            statusDiv.innerText = "SYSTEMS ACTIVE";
        }
    </script>
</body>

</html>