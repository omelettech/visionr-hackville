<!doctype html>
<html>

<head>
    <title>AprilTag Polyphonic 3D Audio</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #222;
            color: #fff;
            text-align: center;
        }

        .status {
            margin-bottom: 20px;
            color: #888;
        }

        button {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            background: #0f0;
            border: none;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        #active-tags-list {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tag-card {
            border: 1px solid #444;
            background: #333;
            padding: 10px;
            border-radius: 8px;
            width: 120px;
        }
    </style>
</head>

<body>
    <h2>Polyphonic 3D Audio Positioner</h2>

    <div class="status" id="connection-status">Connecting to WebSocket...</div>

    <button onclick="initAudio()">Enable Audio (Click Me First)</button>

    <div
        style="margin: 20px 0; padding: 15px; background: #333; border-radius: 8px; display: inline-block; text-align: left; min-width: 300px;">
        <h3 style="margin-top: 0; text-align: center;">Audio Settings</h3>

        <div style="margin-bottom: 10px;">
            <label style="display: block;">
                Motion Threshold (Shake Filter): <span id="threshold-value">0.10</span>
                <input type="range" min="0.01" max="0.5" value="0.10" step="0.01" oninput="updateThreshold(this.value)"
                    style="width: 100%;">
            </label>
        </div>

        <div style="margin-bottom: 10px;">
            <label style="display: block;">
                Idle Beep Interval: <span id="interval-value">1000</span>ms
                <input type="range" min="200" max="5000" value="1000" step="100"
                    oninput="updateBeepInterval(this.value)" style="width: 100%;">
            </label>
        </div>

        <div>
            <label style="display: block;">
                Beep Duration: <span id="duration-value">100</span>ms
                <input type="range" min="50" max="500" value="100" step="10" oninput="updateBeepDuration(this.value)"
                    style="width: 100%;">
            </label>
        </div>
    </div>

    <h3>Active Tags</h3>
    <div id="active-tags-list">Waiting for tags...</div>

    <script src="spatialAudio.js"></script>
    <script>
        const audioManager = new SpatialAudioManager({
            motionThreshold: 0.02,
            idleBeepInterval: 3000
        });

        // Initialize UI with manager defaults
        document.getElementById('threshold-value').innerText = audioManager.MOTION_THRESHOLD.toFixed(2);
        document.getElementById('interval-value').innerText = audioManager.IDLE_BEEP_INTERVAL;
        document.querySelector('input[oninput*="updateThreshold"]').value = audioManager.MOTION_THRESHOLD;
        document.querySelector('input[oninput*="updateBeepInterval"]').value = audioManager.IDLE_BEEP_INTERVAL;

        const socket = new WebSocket('ws://localhost:8765');
        const statusDiv = document.getElementById('connection-status');
        const listDiv = document.getElementById('active-tags-list');

        // --- UI HANDLERS ---
        function updateThreshold(val) {
            audioManager.updateThreshold(val);
            document.getElementById('threshold-value').innerText = audioManager.MOTION_THRESHOLD.toFixed(2);
        }
        function updateBeepInterval(val) {
            audioManager.updateBeepInterval(val);
            document.getElementById('interval-value').innerText = audioManager.IDLE_BEEP_INTERVAL;
        }
        function updateBeepDuration(val) {
            audioManager.updateBeepDuration(val);
            document.getElementById('duration-value').innerText = audioManager.BEEP_DURATION;
        }

        // --- WEBSOCKET LOGIC ---
        socket.addEventListener('open', () => {
            statusDiv.innerText = "Connected to Python Server";
            statusDiv.style.color = "#0f0";
        });

        socket.addEventListener('message', (event) => {
            if (!audioManager.isAudioInit) return;

            const visibleTags = JSON.parse(event.data);
            const visibleIds = new Set();
            let html = "";

            visibleTags.forEach(tag => {
                visibleIds.add(tag.id);

                const x = tag.pose[0] * 5;
                const y = -tag.pose[1] * 5;
                const z = Math.abs(tag.pose[2]);

                const sound = audioManager.activeSounds[tag.id];
                const statusColor = (sound && sound.isMoving) ? "#0f0" : "#ff0";
                const statusText = (sound && sound.isMoving) ? "Moving" : "Idle";

                html += `
                    <div class="tag-card">
                        <div style="font-size:1.5em; color:${statusColor}">${tag.id}</div>
                        <div style="font-size:0.8em">${statusText}</div>
                        <div style="font-size:0.8em">X: ${x.toFixed(1)}</div>
                    </div>
                `;

                if (!audioManager.activeSounds[tag.id]) {
                    audioManager.createSound(tag.id, x, y, z);
                }
                audioManager.updateSoundPosition(tag.id, x, y, z);
            });

            listDiv.innerHTML = html || "No tags visible";

            for (const id in audioManager.activeSounds) {
                if (!visibleIds.has(parseInt(id))) {
                    audioManager.removeSound(id);
                }
            }
        });

        socket.addEventListener('close', () => {
            statusDiv.innerText = "Disconnected";
            statusDiv.style.color = "#f00";
        });

        async function initAudio() {
            await audioManager.init();
        }
    </script>
</body>

</html>